name: Deploy Grafana Cloud Stack

# Provisions the Grafana Cloud stack (and service accounts) via Terraform and
# then imports the LiteLLM dashboards.
#
# Required GitHub Actions secrets (repository or environment level):
#   AZURE_CLIENT_ID            – Federated credential client ID for OIDC
#   AZURE_TENANT_ID            – Azure tenant ID
#   AZURE_SUBSCRIPTION_ID      – Azure subscription ID
#   TF_BACKEND_RG              – Resource group for the Terraform state SA
#   TF_BACKEND_SA              – Storage account name for Terraform state
#   TF_BACKEND_CONTAINER       – Blob container name for Terraform state
#   GRAFANA_CLOUD_ACCESS_POLICY_TOKEN
#                              – Grafana Cloud API token with scopes:
#                                stacks:read, stacks:write,
#                                stack-service-accounts:read,
#                                stack-service-accounts:write
#
# Optional GitHub Actions variables (repository level):
#   GRAFANA_STACK_NAME         – Display name (default: "PVC AI Gateway")
#   GRAFANA_STACK_SLUG         – Unique URL slug (default: "pvc-aigateway")
#   GRAFANA_REGION_SLUG        – Grafana Cloud region (default: "prod-us-central-0")
#
# After a successful apply the job prints the stack URL and reminds you to set
# the GRAFANA_URL and GRAFANA_SA_TOKEN secrets used by deploy-grafana-dashboards.

on:
  push:
    branches:
      - main
    paths:
      - "infra/grafana/**"
      - "infra/modules/grafana_cloud/**"
      - ".github/workflows/deploy-grafana.yaml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  TF_BACKEND_RG: ${{ secrets.TF_BACKEND_RG }}
  TF_BACKEND_SA: ${{ secrets.TF_BACKEND_SA }}
  TF_BACKEND_CONTAINER: ${{ secrets.TF_BACKEND_CONTAINER }}
  # Grafana Cloud provider token
  TF_VAR_grafana_cloud_access_policy_token: ${{ secrets.GRAFANA_CLOUD_ACCESS_POLICY_TOKEN }}
  # Stack configuration (override via repository variables as needed)
  TF_VAR_stack_name: ${{ vars.GRAFANA_STACK_NAME || 'PVC AI Gateway' }}
  TF_VAR_stack_slug: ${{ vars.GRAFANA_STACK_SLUG || 'pvc-aigateway' }}
  TF_VAR_region_slug: ${{ vars.GRAFANA_REGION_SLUG || 'prod-us-central-0' }}

jobs:
  deploy-grafana:
    name: Provision Grafana Cloud Stack
    runs-on: ubuntu-latest
    environment: prod
    defaults:
      run:
        working-directory: infra/grafana

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          missing=0
          for v in \
            AZURE_CLIENT_ID AZURE_TENANT_ID AZURE_SUBSCRIPTION_ID \
            TF_BACKEND_RG TF_BACKEND_SA TF_BACKEND_CONTAINER \
            TF_VAR_grafana_cloud_access_policy_token; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Missing required secret/variable: ${v}"
              missing=1
            fi
          done
          [ "${missing}" -eq 0 ] || exit 1

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.6
          terraform_wrapper: false

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${TF_BACKEND_RG}" \
            -backend-config="storage_account_name=${TF_BACKEND_SA}" \
            -backend-config="container_name=${TF_BACKEND_CONTAINER}" \
            -backend-config="key=grafana.terraform.tfstate"

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Print stack details
        shell: bash
        run: |
          set -euo pipefail
          STACK_URL=$(terraform output -raw stack_url 2>/dev/null || echo "")
          PROM_URL=$(terraform output -raw prometheus_url 2>/dev/null || echo "")
          echo "Grafana Cloud stack deployed successfully."
          echo "  Stack URL:        ${STACK_URL}"
          echo "  Prometheus URL:   ${PROM_URL}"
          echo ""
          echo "Set the following GitHub Actions secrets if not already configured:"
          echo "  GRAFANA_URL      = ${STACK_URL}"
          echo "  GRAFANA_SA_TOKEN = \$(terraform output -raw github_actions_token)"

  deploy-dashboards:
    name: Import LiteLLM dashboards
    # Runs after Terraform apply; requires GRAFANA_URL and GRAFANA_SA_TOKEN to be
    # set as GitHub Actions secrets. On first-run bootstrap these will not yet be
    # set — run `terraform output -raw github_actions_token` locally and set the
    # GRAFANA_URL and GRAFANA_SA_TOKEN secrets, then re-run this workflow or
    # trigger deploy-grafana-dashboards.yaml directly via workflow_dispatch.
    needs: deploy-grafana
    uses: ./.github/workflows/deploy-grafana-dashboards.yaml
    secrets: inherit
